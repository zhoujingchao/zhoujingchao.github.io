(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{484:function(t,s,a){t.exports=a.p+"assets/img/onion.ed22c98c.png"},485:function(t,s,a){t.exports=a.p+"assets/img/app.f0fc6537.png"},486:function(t,s,a){t.exports=a.p+"assets/img/callback.024d3472.png"},487:function(t,s,a){t.exports=a.p+"assets/img/compose.46609fae.png"},591:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"koa洋葱模型分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#koa洋葱模型分析"}},[t._v("#")]),t._v(" koa洋葱模型分析")]),t._v(" "),n("h2",{attrs:{id:"模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模型"}},[t._v("#")]),t._v(" 模型")]),t._v(" "),n("p",[n("img",{attrs:{src:a(484),alt:""}})]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Koa "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'koa'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'st1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'st2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello world'")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello world'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8888")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("st1\nst2\nhello world\nend2\nend1\n")])])]),n("h2",{attrs:{id:"原理浅析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原理浅析"}},[t._v("#")]),t._v(" 原理浅析")]),t._v(" "),n("p",[t._v("我们翻进"),n("code",[t._v("koa")]),t._v("源码"),n("code",[t._v("application.js")]),t._v("瞅一瞅，对着上面用到的方法去找内容。")]),t._v(" "),n("h3",{attrs:{id:"app-use做了什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#app-use做了什么"}},[t._v("#")]),t._v(" app.use做了什么")]),t._v(" "),n("p",[t._v("过滤掉一些暂时用不到的代码")]),t._v(" "),n("p",[n("img",{attrs:{src:a(485),alt:""}})]),t._v(" "),n("p",[t._v("预先通过"),n("code",[t._v("use")]),t._v("方法，将请求可能会经过的中间件装在了一个数组里")]),t._v(" "),n("h3",{attrs:{id:"callback"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#callback"}},[t._v("#")]),t._v(" callback")]),t._v(" "),n("p",[n("img",{attrs:{src:a(486),alt:""}})]),t._v(" "),n("p",[t._v("通过 "),n("code",[t._v("compose()")]),t._v(" 这个方法，就将我们传入的中间件数组关联起来了，最后 "),n("code",[t._v("callback()")]),t._v(" 返回 "),n("code",[t._v("this.handleRequest()")]),t._v(" 的执行结果，暂不管返回什么吧，先看看这个神奇的\n"),n("code",[t._v("compose()")]),t._v(" 方法做了什么使得文章最开始的例子可以那样执行")]),t._v(" "),n("h3",{attrs:{id:"compose"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#compose"}},[t._v("#")]),t._v(" compose")]),t._v(" "),n("p",[n("img",{attrs:{src:a(487),alt:""}})]),t._v(" "),n("ol",[n("li",[t._v("首先会默认执行第一个中间件，返回"),n("code",[t._v("Promise")]),t._v("，被"),n("code",[t._v("Koa")]),t._v("监听，执行对应逻辑")]),t._v(" "),n("li",[t._v("在执行第一个中间件的逻辑时，遇到"),n("code",[t._v("await next()")]),t._v("时，会继续执行"),n("code",[t._v("dispatch(i+1)")]),t._v("，也就是执行 "),n("code",[t._v("dispatch(1)")]),t._v("，会手动触发执行第二个中间件。这时候，第一个中间件"),n("code",[t._v("await next()")]),t._v("后面的代码就会被 "),n("code",[t._v("pending")]),t._v("，等待"),n("code",[t._v("await next()")]),t._v("返回"),n("code",[t._v("Promise")]),t._v("，才会继续执行第一个中间件"),n("code",[t._v("await next()")]),t._v("后面的代码。")]),t._v(" "),n("li",[t._v("以此类推，如果有多个中间件的时候，会依照上面的逻辑不断执行，先执行第一个中间件，在"),n("code",[t._v("await next()")]),t._v(" 出"),n("code",[t._v("pending")]),t._v("，继续执行第二个中间件，继续在"),n("code",[t._v("await next()")]),t._v("出"),n("code",[t._v("pending")]),t._v("，继续执行第三个中间，直到最后一个中间件执行完，然后返回"),n("code",[t._v("Promise")]),t._v("，然后倒数第二个中间件才执行后续的代码并返回"),n("code",[t._v("Promise")]),t._v("，然后是倒数第三个中间件，接着一直以这种方式执行直到第一个中间件执行完，并返回"),n("code",[t._v("Promise")]),t._v("，从而实现开头例子的执行顺序，就好比下面网上很火的一张洋葱图")])]),t._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),n("p",[n("code",[t._v("koa")]),t._v("真香，这"),n("code",[t._v("compose()")]),t._v("函数真骚，所以说"),n("b",[t._v("评价一个好的程序员不是由代码量决定的")]),t._v("。")])])}),[],!1,null,null,null);s.default=e.exports}}]);