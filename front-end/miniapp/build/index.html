<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>工程化落地实践 | Zhoujc&#39;s blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="知识沉淀，好记性不如烂笔头">
    <link rel="preload" href="/assets/css/0.styles.a748b10c.css" as="style"><link rel="preload" href="/assets/js/app.ebc66fdf.js" as="script"><link rel="preload" href="/assets/js/2.d4b9d712.js" as="script"><link rel="preload" href="/assets/js/24.7e974840.js" as="script"><link rel="prefetch" href="/assets/js/10.28e2e44c.js"><link rel="prefetch" href="/assets/js/100.6737e622.js"><link rel="prefetch" href="/assets/js/101.d01e975f.js"><link rel="prefetch" href="/assets/js/102.66a1ad64.js"><link rel="prefetch" href="/assets/js/103.0b7ae2db.js"><link rel="prefetch" href="/assets/js/104.20427db9.js"><link rel="prefetch" href="/assets/js/105.dd6e0546.js"><link rel="prefetch" href="/assets/js/106.71296a63.js"><link rel="prefetch" href="/assets/js/107.c378d5f1.js"><link rel="prefetch" href="/assets/js/11.e6454622.js"><link rel="prefetch" href="/assets/js/12.0e09de73.js"><link rel="prefetch" href="/assets/js/13.eb107cd6.js"><link rel="prefetch" href="/assets/js/14.6e619cc0.js"><link rel="prefetch" href="/assets/js/15.e0635319.js"><link rel="prefetch" href="/assets/js/16.a8da7a87.js"><link rel="prefetch" href="/assets/js/17.fbe39a52.js"><link rel="prefetch" href="/assets/js/18.bd853f5f.js"><link rel="prefetch" href="/assets/js/19.c8bd314a.js"><link rel="prefetch" href="/assets/js/20.3c574518.js"><link rel="prefetch" href="/assets/js/21.99a75cd7.js"><link rel="prefetch" href="/assets/js/22.42934391.js"><link rel="prefetch" href="/assets/js/23.8b82970c.js"><link rel="prefetch" href="/assets/js/25.87e00c33.js"><link rel="prefetch" href="/assets/js/26.8b357711.js"><link rel="prefetch" href="/assets/js/27.4b69f932.js"><link rel="prefetch" href="/assets/js/28.766b5a05.js"><link rel="prefetch" href="/assets/js/29.aac35f3d.js"><link rel="prefetch" href="/assets/js/3.c3a1c082.js"><link rel="prefetch" href="/assets/js/30.ad955432.js"><link rel="prefetch" href="/assets/js/31.e4e4890f.js"><link rel="prefetch" href="/assets/js/32.6b284fe4.js"><link rel="prefetch" href="/assets/js/33.a22f85f8.js"><link rel="prefetch" href="/assets/js/34.5ac595eb.js"><link rel="prefetch" href="/assets/js/35.01736eef.js"><link rel="prefetch" href="/assets/js/36.63d4161d.js"><link rel="prefetch" href="/assets/js/37.ac568153.js"><link rel="prefetch" href="/assets/js/38.6ab48214.js"><link rel="prefetch" href="/assets/js/39.73e8152b.js"><link rel="prefetch" href="/assets/js/4.272a9fbd.js"><link rel="prefetch" href="/assets/js/40.2c194813.js"><link rel="prefetch" href="/assets/js/41.fe37b6f6.js"><link rel="prefetch" href="/assets/js/42.6f73345b.js"><link rel="prefetch" href="/assets/js/43.adc53b2c.js"><link rel="prefetch" href="/assets/js/44.310ae361.js"><link rel="prefetch" href="/assets/js/45.32e660b6.js"><link rel="prefetch" href="/assets/js/46.04890be7.js"><link rel="prefetch" href="/assets/js/47.4a68ffe5.js"><link rel="prefetch" href="/assets/js/48.90a9137b.js"><link rel="prefetch" href="/assets/js/49.58b6c3b6.js"><link rel="prefetch" href="/assets/js/5.f83283dc.js"><link rel="prefetch" href="/assets/js/50.043bd85d.js"><link rel="prefetch" href="/assets/js/51.c53db7d0.js"><link rel="prefetch" href="/assets/js/52.b419676d.js"><link rel="prefetch" href="/assets/js/53.36f713df.js"><link rel="prefetch" href="/assets/js/54.8002161b.js"><link rel="prefetch" href="/assets/js/55.cc1fc344.js"><link rel="prefetch" href="/assets/js/56.05a6ea6d.js"><link rel="prefetch" href="/assets/js/57.90a9d9ee.js"><link rel="prefetch" href="/assets/js/58.7b07447f.js"><link rel="prefetch" href="/assets/js/59.c17fc2f2.js"><link rel="prefetch" href="/assets/js/6.8a86adbf.js"><link rel="prefetch" href="/assets/js/60.66b80346.js"><link rel="prefetch" href="/assets/js/61.3a7ccc82.js"><link rel="prefetch" href="/assets/js/62.fb35378d.js"><link rel="prefetch" href="/assets/js/63.27e61864.js"><link rel="prefetch" href="/assets/js/64.64d01d10.js"><link rel="prefetch" href="/assets/js/65.a80a9fc0.js"><link rel="prefetch" href="/assets/js/66.5dc463c7.js"><link rel="prefetch" href="/assets/js/67.4a805afa.js"><link rel="prefetch" href="/assets/js/68.8287eee7.js"><link rel="prefetch" href="/assets/js/69.892294f6.js"><link rel="prefetch" href="/assets/js/7.5465fa65.js"><link rel="prefetch" href="/assets/js/70.e0ec7ddd.js"><link rel="prefetch" href="/assets/js/71.7256a53d.js"><link rel="prefetch" href="/assets/js/72.f96155a0.js"><link rel="prefetch" href="/assets/js/73.5a0eb88e.js"><link rel="prefetch" href="/assets/js/74.23636aea.js"><link rel="prefetch" href="/assets/js/75.50267214.js"><link rel="prefetch" href="/assets/js/76.56bf8931.js"><link rel="prefetch" href="/assets/js/77.50bf124e.js"><link rel="prefetch" href="/assets/js/78.16447a1c.js"><link rel="prefetch" href="/assets/js/79.04aa7ebf.js"><link rel="prefetch" href="/assets/js/8.87101dd9.js"><link rel="prefetch" href="/assets/js/80.5d01a188.js"><link rel="prefetch" href="/assets/js/81.f8607d18.js"><link rel="prefetch" href="/assets/js/82.34e8cb67.js"><link rel="prefetch" href="/assets/js/83.947a3b57.js"><link rel="prefetch" href="/assets/js/84.1c193059.js"><link rel="prefetch" href="/assets/js/85.8b1b503f.js"><link rel="prefetch" href="/assets/js/86.c530b306.js"><link rel="prefetch" href="/assets/js/87.06e6da51.js"><link rel="prefetch" href="/assets/js/88.10805f35.js"><link rel="prefetch" href="/assets/js/89.60cd520b.js"><link rel="prefetch" href="/assets/js/9.4e64f5b9.js"><link rel="prefetch" href="/assets/js/90.5d7e2d93.js"><link rel="prefetch" href="/assets/js/91.ddff81c9.js"><link rel="prefetch" href="/assets/js/92.d7928325.js"><link rel="prefetch" href="/assets/js/93.33fd0965.js"><link rel="prefetch" href="/assets/js/94.560df3d9.js"><link rel="prefetch" href="/assets/js/95.283a51cc.js"><link rel="prefetch" href="/assets/js/96.a8d91103.js"><link rel="prefetch" href="/assets/js/97.fe4a7179.js"><link rel="prefetch" href="/assets/js/98.064d454e.js"><link rel="prefetch" href="/assets/js/99.f6443506.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a748b10c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Zhoujc's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end/" class="nav-link router-link-active">
  前端相关
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node实践
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end/" class="nav-link router-link-active">
  前端相关
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node实践
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/front-end/" aria-current="page" class="sidebar-link">前端系列</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器和网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>小程序</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end/miniapp/build/" aria-current="page" class="active sidebar-link">工程化落地实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#开发痛点" class="sidebar-link">开发痛点</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#技术选型" class="sidebar-link">技术选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#构建基础" class="sidebar-link">构建基础</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#css-预编译" class="sidebar-link">css 预编译</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#css-modules" class="sidebar-link">css modules</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#ts" class="sidebar-link">ts</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#eslint" class="sidebar-link">eslint</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#热更新" class="sidebar-link">热更新</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#快速生成页面和组件模版" class="sidebar-link">快速生成页面和组件模版</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#feature-待扩展" class="sidebar-link">feature 待扩展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#axml-转为-jsx" class="sidebar-link">axml 转为 jsx</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#包优化" class="sidebar-link">包优化</a></li><li class="sidebar-sub-header"><a href="/front-end/miniapp/build/#引入单测" class="sidebar-link">引入单测</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>绘图</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="工程化落地实践"><a href="#工程化落地实践" class="header-anchor">#</a> 工程化落地实践</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>自从 2020 年底接触支付宝和手淘小程序以来，在上手小程序业务体系中，个人对于小程序的开发效率看法着实不高。虽然听说过<code>rax</code>、<code>uni-app</code>、<code>taro</code>等框架，但本人跨端经验几乎没有，曾经最多有些许<code>hybrid app</code>经验。恰巧现在维护的项目是原生小程序，所以借此机会，衍生拓展工程化，打造高效的开发体系。在这里也多提一句，在使用任何框架或者工具的时候，其实我们回归底层去掌握它们的核心原理，才能让我们事半功倍，更加深入的理解我们现在使用的东西。</p> <h2 id="开发痛点"><a href="#开发痛点" class="header-anchor">#</a> 开发痛点</h2> <ol><li>我相信应该没人会在小程序开发工具里编码吧，几乎绝大多数开发者都是用自己熟悉的代码编辑器在工作。但是流程上的一些东西，我们必须依赖小程序开发工具，因此小程序开发工具的体验是对于开发者效率提升也是比较重要的一环。</li> <li>css 预处理（less，sass，stylus）无法使用，有些 IDE 的插件可以监听编译（vscode 有<a href="https://github.com/mrcrowl/vscode-easy-less" target="_blank" rel="noopener noreferrer">Easy-less<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>插件可以使用），但不同编辑器需要额外安装（前提是它得有支持的插件，不然你得自己造）。</li> <li>编码繁琐，在创建一个页面或组件时需要新建 4 个文件.axml、.js、.json、.acss，复制粘贴删除操作。</li> <li>项目长期维护，团队多人协作，代码风格、使用的编辑器不一致等等，规范的工程化实践存在就非常重要。</li> <li>生产环境除了小程序开发工具自身提供的优化，项目工程无工程化，基本无任何优化能力。</li></ol> <h2 id="技术选型"><a href="#技术选型" class="header-anchor">#</a> 技术选型</h2> <p>工程化首选当之无愧 webpack，但是在调研过程中打包出来的代码存在 eval 注入函数，在小程序容器里是不允许执行的，卡了很久没找到解决办法。迫于业务节奏和期望快速构建落地，并且基于已有同学开展了 gulp 部分工作，就以 gulp 为基调开展了工程化。这里是 <a href="https://github.com/zhoujingchao/miniapp-gulp-demo" target="_blank" rel="noopener noreferrer">demo<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 仓库地址。</p> <h3 id="构建基础"><a href="#构建基础" class="header-anchor">#</a> 构建基础</h3> <p>小程序的运行依赖于 mini.project.json 配置文件里的指定根目录</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// mini.project.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;component2&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;axmlStrictCheck&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;enableAppxNg&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;enableNodeModuleBabelTransform&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;include&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;prefetch.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exclude&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;client/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node_modules/**&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;miniprogramRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 最终的源码根目录</span>
  <span class="token property">&quot;enableParallelLoader&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;beforeUpload&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tnpm --by=yarn build&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>构建脚本 gulpfile.js，将业务源码，编译到打包目录 dist，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gulpChanged <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-changed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SOURCE</span> <span class="token operator">=</span> <span class="token string">'./client/**/*'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DESTINATION</span> <span class="token operator">=</span> <span class="token string">'./dist/'</span><span class="token punctuation">;</span>

<span class="token comment">// 将需要的文件放入 dist 目录。</span>
<span class="token keyword">const</span> <span class="token function-variable function">assembleFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">SOURCE</span><span class="token punctuation">,</span> <span class="token string">'!./client/**/*.less'</span><span class="token punctuation">,</span> <span class="token string">'!./client/**/*.ts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">gulpChanged</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 根据package.json的运行时依赖打包到 dist 目录中，同时复制package.json文件。</span>
<span class="token keyword">const</span> <span class="token function-variable function">buildDependencies</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">gulpChanged</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">gulpInstall</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        production<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 只安装运行依赖</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除目标文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> force<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 编译成最终的开发包</span>
<span class="token keyword">const</span> buildApp <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>buildDependencies<span class="token punctuation">,</span> assembleFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>dev <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> buildApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="css-预编译"><a href="#css-预编译" class="header-anchor">#</a> css 预编译</h3> <p>这里以 less 为例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> less <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-less'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gulpRename <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-rename'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将 less 文件编译为小程序工具识别的到的 acss 文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">lessc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./client/**/*.less'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">less</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">gulpRename</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">.</span>extname <span class="token operator">=</span> <span class="token string">'.acss'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>此时，我们已经可以使用 less 了，但是当我们抽离公共样式后，再编辑公共样式文件，其它 import 这公共样式的业务文件却不会更新视图，此时的源码包括打包后的源码都已经更新了。经过一番波折并且验证 h5 浏览器场景下排除了 less 以及 gulp-less 的问题后，提供复现 demo 给到小程序容器组帮忙 debug 看下，才找到原因：<b>在小程序的容器里，公共 less 文件变化了，引用的文件没有变，编译也都编译了这个 case 下，gulp dest 里面执行的 writeFile 后 updateMeta 写入的文件 mtime 和 atime 依然是老的，从而导致 webpack 的 watchpack 基于 mtime 进行检测认为这个文件并没有变化，小程序内部是用 webpack 构建的</b>，所以就没有更新。</p> <p>因此，添加处理器手动更改时间。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> through2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'through2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">lessc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./client/**/*.less'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">less</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">gulpRename</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">.</span>extname <span class="token operator">=</span> <span class="token string">'.acss'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      through2<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> enc<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        file<span class="token punctuation">.</span>stat<span class="token punctuation">.</span>mtime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file<span class="token punctuation">.</span>stat<span class="token punctuation">.</span>atime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="css-modules"><a href="#css-modules" class="header-anchor">#</a> css modules</h3> <p>在上面的 less 编译下，可以通过一些包来快速添加 css modules。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> postcss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-postcss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> autoprefixer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'autoprefixer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss-modules'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">lessc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./client/**/*.less'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">less</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">autoprefixer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">gulpRename</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">.</span>extname <span class="token operator">=</span> <span class="token string">'.acss'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      through2<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> enc<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        file<span class="token punctuation">.</span>stat<span class="token punctuation">.</span>mtime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file<span class="token punctuation">.</span>stat<span class="token punctuation">.</span>atime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这种 css modules 方式在当下情况可以快速使用。思路就是新增了 css.json 文件来依托关系。在组件或者页面的 js 逻辑里引用 css.json，弊端是无法用 js 变量来充当类名。</p> <h3 id="ts"><a href="#ts" class="header-anchor">#</a> ts</h3> <p>添加 babel-loader</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">js</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'./client/**/*.{js,ts}'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">gulpChanged</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-typescript'</span><span class="token punctuation">,</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/transform-runtime'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token constant">DESTINATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="eslint"><a href="#eslint" class="header-anchor">#</a> eslint</h3> <p>添加 eslint</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> eslint <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-eslint'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">lint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'client/**/*.{js,ts}'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">eslint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> useEslintrc<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>eslint<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>eslint<span class="token punctuation">.</span><span class="token function">failAfterError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="热更新"><a href="#热更新" class="header-anchor">#</a> 热更新</h3> <p>assembleFiles，lint，js，lessc 等等函数就是上面各个环节对应的任务处理，我们最后在 dev 脚本处添加上处理顺序即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">watchOrigin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">gulpWatch</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token constant">SOURCE</span><span class="token punctuation">,</span> <span class="token string">'!./client/**/*.less'</span><span class="token punctuation">,</span> <span class="token string">'!./client/**/*.{js,ts}'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    assembleFiles
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">watching</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">gulpWatch</span><span class="token punctuation">(</span><span class="token string">'client/**/*.{js,ts}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>lint<span class="token punctuation">,</span> js<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 首次需要编译</span>
  <span class="token function">gulpWatch</span><span class="token punctuation">(</span><span class="token string">'./client/**/*.less'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> ignoreInitial<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> lessc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">watchOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>dev <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> buildApp<span class="token punctuation">,</span> js<span class="token punctuation">,</span> watching<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="快速生成页面和组件模版"><a href="#快速生成页面和组件模版" class="header-anchor">#</a> 快速生成页面和组件模版</h3> <p>准备好自行需要的页面和组件模版</p> <img width="50%" src="/assets/img/template.52432e99.png"> <p>通过 <a href="https://www.npmjs.com/package/inquirer" target="_blank" rel="noopener noreferrer">inquirer<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>库创建流程，最终按流程生成对应的模版文件，查看代码移步<a href="https://github.com/zhoujingchao/miniapp-gulp-demo" target="_blank" rel="noopener noreferrer">demo<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><img src="/assets/img/create.a5f0fe4e.png" alt=""></p> <h2 id="feature-待扩展"><a href="#feature-待扩展" class="header-anchor">#</a> feature 待扩展</h2> <p>webpack 更加熟练一些，后续还是会通过 webpack 去做下面的扩展。</p> <h3 id="axml-转为-jsx"><a href="#axml-转为-jsx" class="header-anchor">#</a> axml 转为 jsx</h3> <p>更高效的编写组件，并且我们习以为常的 css modules 编写方式，可以在这里再进行尝试。之前快速落地的时候，新增 css.json 的方式来用其实是不太习惯和优雅的。</p> <h3 id="包优化"><a href="#包优化" class="header-anchor">#</a> 包优化</h3> <p>核心就是降体积。</p> <ul><li>生产环境源码的压缩和混淆</li> <li>页面组件的按需加载</li></ul> <h3 id="引入单测"><a href="#引入单测" class="header-anchor">#</a> 引入单测</h3> <p>核心模块，公共模块等</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-end/mobile/jsbridge/" class="prev">
        Hybrid App的理解与思考
      </a></span> <span class="next"><a href="/front-end/draw/radius/">
        SVG 方形图实现圆角效果
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ebc66fdf.js" defer></script><script src="/assets/js/2.d4b9d712.js" defer></script><script src="/assets/js/24.7e974840.js" defer></script>
  </body>
</html>
