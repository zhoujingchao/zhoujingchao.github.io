<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解promise | Zhoujc&#39;s blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="知识沉淀，好记性不如烂笔头">
    <link rel="preload" href="/assets/css/0.styles.a748b10c.css" as="style"><link rel="preload" href="/assets/js/app.ebc66fdf.js" as="script"><link rel="preload" href="/assets/js/2.d4b9d712.js" as="script"><link rel="preload" href="/assets/js/91.ddff81c9.js" as="script"><link rel="prefetch" href="/assets/js/10.28e2e44c.js"><link rel="prefetch" href="/assets/js/100.6737e622.js"><link rel="prefetch" href="/assets/js/101.d01e975f.js"><link rel="prefetch" href="/assets/js/102.66a1ad64.js"><link rel="prefetch" href="/assets/js/103.0b7ae2db.js"><link rel="prefetch" href="/assets/js/104.20427db9.js"><link rel="prefetch" href="/assets/js/105.dd6e0546.js"><link rel="prefetch" href="/assets/js/106.71296a63.js"><link rel="prefetch" href="/assets/js/107.c378d5f1.js"><link rel="prefetch" href="/assets/js/11.e6454622.js"><link rel="prefetch" href="/assets/js/12.0e09de73.js"><link rel="prefetch" href="/assets/js/13.eb107cd6.js"><link rel="prefetch" href="/assets/js/14.6e619cc0.js"><link rel="prefetch" href="/assets/js/15.e0635319.js"><link rel="prefetch" href="/assets/js/16.a8da7a87.js"><link rel="prefetch" href="/assets/js/17.fbe39a52.js"><link rel="prefetch" href="/assets/js/18.bd853f5f.js"><link rel="prefetch" href="/assets/js/19.c8bd314a.js"><link rel="prefetch" href="/assets/js/20.3c574518.js"><link rel="prefetch" href="/assets/js/21.99a75cd7.js"><link rel="prefetch" href="/assets/js/22.42934391.js"><link rel="prefetch" href="/assets/js/23.8b82970c.js"><link rel="prefetch" href="/assets/js/24.7e974840.js"><link rel="prefetch" href="/assets/js/25.87e00c33.js"><link rel="prefetch" href="/assets/js/26.8b357711.js"><link rel="prefetch" href="/assets/js/27.4b69f932.js"><link rel="prefetch" href="/assets/js/28.766b5a05.js"><link rel="prefetch" href="/assets/js/29.aac35f3d.js"><link rel="prefetch" href="/assets/js/3.c3a1c082.js"><link rel="prefetch" href="/assets/js/30.ad955432.js"><link rel="prefetch" href="/assets/js/31.e4e4890f.js"><link rel="prefetch" href="/assets/js/32.6b284fe4.js"><link rel="prefetch" href="/assets/js/33.a22f85f8.js"><link rel="prefetch" href="/assets/js/34.5ac595eb.js"><link rel="prefetch" href="/assets/js/35.01736eef.js"><link rel="prefetch" href="/assets/js/36.63d4161d.js"><link rel="prefetch" href="/assets/js/37.ac568153.js"><link rel="prefetch" href="/assets/js/38.6ab48214.js"><link rel="prefetch" href="/assets/js/39.73e8152b.js"><link rel="prefetch" href="/assets/js/4.272a9fbd.js"><link rel="prefetch" href="/assets/js/40.2c194813.js"><link rel="prefetch" href="/assets/js/41.fe37b6f6.js"><link rel="prefetch" href="/assets/js/42.6f73345b.js"><link rel="prefetch" href="/assets/js/43.adc53b2c.js"><link rel="prefetch" href="/assets/js/44.310ae361.js"><link rel="prefetch" href="/assets/js/45.32e660b6.js"><link rel="prefetch" href="/assets/js/46.04890be7.js"><link rel="prefetch" href="/assets/js/47.4a68ffe5.js"><link rel="prefetch" href="/assets/js/48.90a9137b.js"><link rel="prefetch" href="/assets/js/49.58b6c3b6.js"><link rel="prefetch" href="/assets/js/5.f83283dc.js"><link rel="prefetch" href="/assets/js/50.043bd85d.js"><link rel="prefetch" href="/assets/js/51.c53db7d0.js"><link rel="prefetch" href="/assets/js/52.b419676d.js"><link rel="prefetch" href="/assets/js/53.36f713df.js"><link rel="prefetch" href="/assets/js/54.8002161b.js"><link rel="prefetch" href="/assets/js/55.cc1fc344.js"><link rel="prefetch" href="/assets/js/56.05a6ea6d.js"><link rel="prefetch" href="/assets/js/57.90a9d9ee.js"><link rel="prefetch" href="/assets/js/58.7b07447f.js"><link rel="prefetch" href="/assets/js/59.c17fc2f2.js"><link rel="prefetch" href="/assets/js/6.8a86adbf.js"><link rel="prefetch" href="/assets/js/60.66b80346.js"><link rel="prefetch" href="/assets/js/61.3a7ccc82.js"><link rel="prefetch" href="/assets/js/62.fb35378d.js"><link rel="prefetch" href="/assets/js/63.27e61864.js"><link rel="prefetch" href="/assets/js/64.64d01d10.js"><link rel="prefetch" href="/assets/js/65.a80a9fc0.js"><link rel="prefetch" href="/assets/js/66.5dc463c7.js"><link rel="prefetch" href="/assets/js/67.4a805afa.js"><link rel="prefetch" href="/assets/js/68.8287eee7.js"><link rel="prefetch" href="/assets/js/69.892294f6.js"><link rel="prefetch" href="/assets/js/7.5465fa65.js"><link rel="prefetch" href="/assets/js/70.e0ec7ddd.js"><link rel="prefetch" href="/assets/js/71.7256a53d.js"><link rel="prefetch" href="/assets/js/72.f96155a0.js"><link rel="prefetch" href="/assets/js/73.5a0eb88e.js"><link rel="prefetch" href="/assets/js/74.23636aea.js"><link rel="prefetch" href="/assets/js/75.50267214.js"><link rel="prefetch" href="/assets/js/76.56bf8931.js"><link rel="prefetch" href="/assets/js/77.50bf124e.js"><link rel="prefetch" href="/assets/js/78.16447a1c.js"><link rel="prefetch" href="/assets/js/79.04aa7ebf.js"><link rel="prefetch" href="/assets/js/8.87101dd9.js"><link rel="prefetch" href="/assets/js/80.5d01a188.js"><link rel="prefetch" href="/assets/js/81.f8607d18.js"><link rel="prefetch" href="/assets/js/82.34e8cb67.js"><link rel="prefetch" href="/assets/js/83.947a3b57.js"><link rel="prefetch" href="/assets/js/84.1c193059.js"><link rel="prefetch" href="/assets/js/85.8b1b503f.js"><link rel="prefetch" href="/assets/js/86.c530b306.js"><link rel="prefetch" href="/assets/js/87.06e6da51.js"><link rel="prefetch" href="/assets/js/88.10805f35.js"><link rel="prefetch" href="/assets/js/89.60cd520b.js"><link rel="prefetch" href="/assets/js/9.4e64f5b9.js"><link rel="prefetch" href="/assets/js/90.5d7e2d93.js"><link rel="prefetch" href="/assets/js/92.d7928325.js"><link rel="prefetch" href="/assets/js/93.33fd0965.js"><link rel="prefetch" href="/assets/js/94.560df3d9.js"><link rel="prefetch" href="/assets/js/95.283a51cc.js"><link rel="prefetch" href="/assets/js/96.a8d91103.js"><link rel="prefetch" href="/assets/js/97.fe4a7179.js"><link rel="prefetch" href="/assets/js/98.064d454e.js"><link rel="prefetch" href="/assets/js/99.f6443506.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a748b10c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Zhoujc's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end/" class="nav-link router-link-active">
  前端相关
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node实践
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end/" class="nav-link router-link-active">
  前端相关
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node实践
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/front-end/" aria-current="page" class="sidebar-link">前端系列</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end/js/event-loop/" class="sidebar-link">js执行机制详解</a></li><li><a href="/front-end/js/promise/" aria-current="page" class="active sidebar-link">深入理解promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/js/promise/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#原理分析" class="sidebar-link">原理分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/js/promise/#极简的promise雏形" class="sidebar-link">极简的promise雏形</a></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#加入延时机制" class="sidebar-link">加入延时机制</a></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#加入状态" class="sidebar-link">加入状态</a></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#链式promise" class="sidebar-link">链式Promise</a></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#失败处理" class="sidebar-link">失败处理</a></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#异常处理" class="sidebar-link">异常处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/js/promise/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/front-end/js/prototype/" class="sidebar-link">深入理解js原型</a></li><li><a href="/front-end/js/flatten/" class="sidebar-link">数组扁平化</a></li><li><a href="/front-end/js/throttle/" class="sidebar-link">节流与防抖</a></li><li><a href="/front-end/js/curry/" class="sidebar-link">函数柯里化</a></li><li><a href="/front-end/js/continuous-assignment/" class="sidebar-link">连续赋值的理解</a></li><li><a href="/front-end/js/design/factory.html" class="sidebar-link">设计模式-工厂函数</a></li><li><a href="/front-end/js/design/constructor.html" class="sidebar-link">设计模式-构造函数</a></li><li><a href="/front-end/js/bind/" class="sidebar-link">模拟实现call, apply, bind</a></li><li><a href="/front-end/js/closure/" class="sidebar-link">一道经典的闭包面试题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器和网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>绘图</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深入理解promise"><a href="#深入理解promise" class="header-anchor">#</a> 深入理解promise</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>探索 Promise 设计原理，帮助我们深入理解及使用。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// example 1：这是一种最普遍的获取用户信息的请求逻辑</span>
<span class="token keyword">function</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 异步请求</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>getUserInfo</code>方法返回一个<code>promise</code>，可以通过它的<code>then</code>方法注册在<code>promise</code>异步操作成功时执行的回调。这种执行方式，使得异步调用变得顺手.</p> <h2 id="原理分析"><a href="#原理分析" class="header-anchor">#</a> 原理分析</h2> <p>那么类似这种功能的<code>Promise</code>是怎么实现的呢？首先看一下最基础的雏形方法吧。</p> <h3 id="极简的promise雏形"><a href="#极简的promise雏形" class="header-anchor">#</a> 极简的promise雏形</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放回调注册的函数</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码逻辑大致这样:</p> <ol><li>调用<code>then</code>方法，将想要在<code>Promise</code>异步操作成功时执行回调放入<code>callbacks</code>队列，可以理解为注册回调函数，延伸下去向观察者模式思考。</li> <li>创建<code>Promise</code>实例时传入的函数会被赋予一个函数类型的参数，即<code>resolve</code>，他接受一个参数value，代表异步操作返回的结果，当异步操作执行成功 后，会调用<code>resolve</code>方法，这时候其实真正执行的操作是将<code>callbacks</code>队列中的回调一一执行。</li></ol> <p>结合中<code>example 1</code>的代码来看，首先<code>new Promise</code>时，传给<code>promise</code>的函数发送异步请求，接着调用<code>promise</code>对象的<code>then</code>属性，注册请求成功的回调函数，然后当异步请求发送成功时，调用<code>resolve(res)</code>方法, 该方法执行<code>then</code>方法注册的回调数组。</p> <p>那么问题来了有同学会问，<code>then</code>方法应该能够链式调用，但是上面的最基础简单的版本显然无法支持链式调用啊。so想让<code>then</code>方法支持链式调用，接着往下看</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
</code></pre></div><p>只要这样就可以实现链式调用了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// example 2</span>
<span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="加入延时机制"><a href="#加入延时机制" class="header-anchor">#</a> 加入延时机制</h3> <p>细心的同学应该发现，上述代码还存在一个问题：如果在<code>then</code>方法注册回调之前，<code>resolve</code>函数就执行了，怎么办？比如<code>promise</code>内部的函数是同步函数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// example 3</span>
<span class="token keyword">function</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'gg'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这显然是不允许的，Promises/A+规范<strong>明确要求回调需要通过异步方式</strong>执行，用以保证一致可靠的执行顺序。因此我们要加入一些处理，保证在<code>resolve</code>执行之前，<code>then</code>方法已经注册完所有的回调。我们可以这样改造下<code>resolve</code>函数:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码的思路大家都明白，就是通过<code>setTimeout</code>机制，将<code>resolve</code>中执行回调的逻辑放置到JS任务队列末尾，以保证在<code>resolve</code>执行时，<code>then</code>方法的回调函数已经注册完成.
那么问题又来了某些同学又发现一个问题，可以细想一下：如果<code>Promise</code>异步操作已经成功，这时，在异步操作成功之前注册的回调都会执行，但是在<code>Promise</code>异步操作成功这之后调用的then注册的回调就再也不会执行了，这显然不是我们想要的。</p> <h3 id="加入状态"><a href="#加入状态" class="header-anchor">#</a> 加入状态</h3> <p>恩，为了解决上一节抛出的问题，我们必须加入状态机制，也就是大家熟知的<code>pending</code>、<code>fulfilled</code>、<code>rejected</code>。</p> <p>Promises/A+规范中的2.1Promise States中明确规定了，<code>pending</code>可以转化为<code>fulfilled</code>或<code>rejected</code>并且只能转化一次，也就是说如果<code>pending</code>转化到<code>fulfilled</code>状态，那么就不能再转化到<code>rejected</code>。并且<code>fulfilled</code>和<code>rejected</code>状态只能由<code>pending</code>转化而来，两者之间不能互相转换。
改进后的代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token string">'pendding'</span><span class="token punctuation">,</span>
  value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token string">'pendding'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> newValue<span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码的思路是这样的：<code>resolve</code>执行时，会将状态设置为<code>fulfilled</code>，在此之后调用<code>then</code>添加的新回调，都会立即执行。
这里没有任何地方将<code>state</code>设为<code>rejected</code>，为了让大家聚焦在核心代码上，这个问题后面会有一小节专门加入。</p> <h3 id="链式promise"><a href="#链式promise" class="header-anchor">#</a> 链式Promise</h3> <p>那么这里问题又来了某些同学还会问，如果用户在<code>then</code>函数里面注册的仍然是一个<code>Promise</code>，该如何解决？比如下面的<code>example 4</code>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>getUserDad<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// handle</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">getUserDad</span><span class="token punctuation">(</span><span class="token parameter">userInfoObj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url <span class="token operator">+</span> userInfoObj<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这种场景相信用过<code>promise</code>的人都知道会有很多，那么类似这种就是所谓的链式<code>Promise</code>。</p> <p>链式<code>Promise</code>是指在当前<code>promise</code>达到<code>fulfilled</code>状态后，即开始进行下一个<code>promise</code>（后邻promise）。那么我们如何衔接当前promise和后邻promise呢？接着我那会下看：
只要在<code>then</code>方法里面<code>return</code>一个<code>promise</code>就好啦。Promises/A+规范中的2.2.7就是这么说哒😊</p> <p>下面来看看这段暗藏玄机的<code>then</code>方法和<code>resolve</code>方法改造代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token string">'pendding'</span><span class="token punctuation">,</span>
  value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        onFulfilled<span class="token operator">:</span> onFulfilled <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        resolve<span class="token operator">:</span> resolve
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token string">'pendding'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// nothing in then</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>callback<span class="token punctuation">.</span>onFulfilled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callback<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> ret <span class="token operator">=</span> callback<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    callback<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newValue <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newValue <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> then <span class="token operator">=</span> newValue<span class="token punctuation">.</span>then
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    value <span class="token operator">=</span> newValue<span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handle</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面结合<code>example 4</code>的代码，分析下上面的代码逻辑：</p> <ol><li><code>example 4</code>的<code>then</code>方法中，创建并返回了新的Promise实例，这是串行<code>Promise</code>的基础，并且支持链式调用。</li> <li><code>handle</code>方法是<code>promise</code>内部的方法。<code>then</code>方法传入的形参<code>onFulfilled</code>以及创建新<code>Promise</code>实例时传入的<code>resolve</code>均被<code>push</code>到当前<code>promise</code>的<code>callbacks</code>队列中，这是衔接当前promise和后邻promise的关键所在（这里一定要好好的分析下handle的作用）。</li> <li><code>getUserInfo</code>生成的<code>promise</code>异步操作成功，执行其内部方法<code>resolve</code>，传入的参数正是异步操作的结果即用户信息的对象userInfoObj</li> <li>调用<code>handle</code>方法处理<code>callbacks</code>队列中的回调：<code>getUserDad</code>方法，生成新的<code>promise</code>（getUserDad promise）</li> <li>执行之前由<code>getUserInfo promise</code>的<code>then</code>方法生成的新<code>promise</code>(称为bridge promise)的<code>resolve</code>方法，传入参数为<code>getUserDad promise</code>。这种情况下，会将该<code>resolve</code>方法传入<code>getUserDad promise</code>的<code>then</code>方法中，并直接返回。</li> <li><code>getUserDad promise</code>异步操作成功时，执行其<code>callbacks</code>中的回调：<code>getUserInfo bridge promise</code>中的<code>resolve</code>方法</li> <li>最后执行<code>getUserDad bridge promise</code>的后邻<code>promise</code>的<code>callbacks</code>中的回调。</li></ol> <h3 id="失败处理"><a href="#失败处理" class="header-anchor">#</a> 失败处理</h3> <p>在异步操作失败时，标记其状态为<code>rejected</code>，并执行注册的失败回调:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// example 5</span>
<span class="token keyword">function</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle res</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>有了之前处理<code>fulfilled</code>状态的经验，支持错误处理变得很容易,只需要在注册回调、处理状态变更上都要加入新的逻辑：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token string">'pendding'</span><span class="token punctuation">,</span>
  value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        onFulfilled<span class="token operator">:</span> onFulfilled <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        resolve<span class="token operator">:</span> resolve<span class="token punctuation">,</span>
        onRejected<span class="token operator">:</span> onRejected <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        reject<span class="token operator">:</span> reject
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token string">'pendding'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> ret<span class="token punctuation">,</span>
      cb <span class="token operator">=</span> state <span class="token operator">===</span> <span class="token string">'fulfilled'</span> <span class="token operator">?</span> callback<span class="token punctuation">.</span>onFulfilled <span class="token operator">:</span> callback<span class="token punctuation">.</span>onRejected<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cb <span class="token operator">=</span> state <span class="token operator">===</span> <span class="token string">'fulfilled'</span> <span class="token operator">?</span> callback<span class="token punctuation">.</span>resolve <span class="token operator">:</span> callback<span class="token punctuation">.</span>reject
      <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ret <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    callback<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newValue <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newValue <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> then <span class="token operator">=</span> newValue<span class="token punctuation">.</span>then
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    value <span class="token operator">=</span> newValue<span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> reason<span class="token punctuation">,</span> state <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handle</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码增加了新的<code>reject</code>方法，供异步操作失败时调用，同时抽出了<code>resolve</code>和<code>reject</code>共用的部分，形成<code>execute</code>方法。</p> <p>错误冒泡是上述代码已经支持，且非常实用的一个特性。在<code>handle</code>中发现没有指定异步操作失败的回调时，会直接将<code>bridge promise</code>(then函数返回的promise，后同)设为<code>rejected</code>状态，如此达成执行后续失败回调的效果。这有利于简化串行<code>Promise</code>的失败处理成本，因为一组异步操作往往会对应一个实际功能，失败处理方法通常是一致的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>getUserDad<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// handle res</span>
  <span class="token punctuation">}</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// there is something wrong in getUserInfo or getUserDad</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h3> <p>细心的同学又会想到：如果在执行成功回调、失败回调时代码出错怎么办？对于这类异常，可以使用<code>try-catch</code>捕获错误，并将<code>bridge promise</code>设为<code>rejected</code>状态。<code>handle</code>方法改造如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token string">'pendding'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> ret<span class="token punctuation">,</span>
    cb <span class="token operator">=</span> state <span class="token operator">===</span> <span class="token string">'fulfilled'</span> <span class="token operator">?</span> callback<span class="token punctuation">.</span>onFulfilled <span class="token operator">:</span> callback<span class="token punctuation">.</span>onRejected<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cb <span class="token operator">=</span> state <span class="token operator">===</span> <span class="token string">'fulfilled'</span> <span class="token operator">?</span> callback<span class="token punctuation">.</span>resolve <span class="token operator">:</span> callback<span class="token punctuation">.</span>reject
    <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    ret <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    callback<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    callback<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果在异步操作中，多次执行<code>resolve</code>或者<code>reject</code>会重复处理后续回调，可以通过内置一个标志位解决。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>这里一定要注意的点是：<code>promise</code>里面的<code>then</code>函数仅仅是注册了后续需要执行的代码，真正的执行是在<code>resolve</code>方法里面执行的，理清了这层，再来分析源码会省力的多。</p> <p>现在回顾下<code>Promise</code>的实现过程，其主要使用了设计模式中的观察者模式：</p> <ol><li>通过<code>Promise.prototype.then</code>和<code>Promise.prototype.catch</code>方法将观察者方法注册到被观察者<code>Promise</code>对象中，同时返回一个新的Promise对象，以便可以链式调用。</li> <li>被观察者管理内部<code>pending</code>、<code>fulfilled</code>和<code>rejected</code>的状态转变，同时通过构造函数中传递的<code>resolve</code>和<code>reject</code>方法以主动触发状态转变和通知观察者。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-end/js/event-loop/" class="prev">
        js执行机制详解
      </a></span> <span class="next"><a href="/front-end/js/prototype/">
        深入理解js原型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ebc66fdf.js" defer></script><script src="/assets/js/2.d4b9d712.js" defer></script><script src="/assets/js/91.ddff81c9.js" defer></script>
  </body>
</html>
