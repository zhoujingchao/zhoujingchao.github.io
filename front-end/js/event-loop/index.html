<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js执行机制详解 | Zhoujc&#39;s blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="知识沉淀，好记性不如烂笔头">
    <link rel="preload" href="/assets/css/0.styles.a748b10c.css" as="style"><link rel="preload" href="/assets/js/app.ebc66fdf.js" as="script"><link rel="preload" href="/assets/js/2.d4b9d712.js" as="script"><link rel="preload" href="/assets/js/12.0e09de73.js" as="script"><link rel="prefetch" href="/assets/js/10.28e2e44c.js"><link rel="prefetch" href="/assets/js/100.6737e622.js"><link rel="prefetch" href="/assets/js/101.d01e975f.js"><link rel="prefetch" href="/assets/js/102.66a1ad64.js"><link rel="prefetch" href="/assets/js/103.0b7ae2db.js"><link rel="prefetch" href="/assets/js/104.20427db9.js"><link rel="prefetch" href="/assets/js/105.dd6e0546.js"><link rel="prefetch" href="/assets/js/106.71296a63.js"><link rel="prefetch" href="/assets/js/107.c378d5f1.js"><link rel="prefetch" href="/assets/js/11.e6454622.js"><link rel="prefetch" href="/assets/js/13.eb107cd6.js"><link rel="prefetch" href="/assets/js/14.6e619cc0.js"><link rel="prefetch" href="/assets/js/15.e0635319.js"><link rel="prefetch" href="/assets/js/16.a8da7a87.js"><link rel="prefetch" href="/assets/js/17.fbe39a52.js"><link rel="prefetch" href="/assets/js/18.bd853f5f.js"><link rel="prefetch" href="/assets/js/19.c8bd314a.js"><link rel="prefetch" href="/assets/js/20.3c574518.js"><link rel="prefetch" href="/assets/js/21.99a75cd7.js"><link rel="prefetch" href="/assets/js/22.42934391.js"><link rel="prefetch" href="/assets/js/23.8b82970c.js"><link rel="prefetch" href="/assets/js/24.7e974840.js"><link rel="prefetch" href="/assets/js/25.87e00c33.js"><link rel="prefetch" href="/assets/js/26.8b357711.js"><link rel="prefetch" href="/assets/js/27.4b69f932.js"><link rel="prefetch" href="/assets/js/28.766b5a05.js"><link rel="prefetch" href="/assets/js/29.aac35f3d.js"><link rel="prefetch" href="/assets/js/3.c3a1c082.js"><link rel="prefetch" href="/assets/js/30.ad955432.js"><link rel="prefetch" href="/assets/js/31.e4e4890f.js"><link rel="prefetch" href="/assets/js/32.6b284fe4.js"><link rel="prefetch" href="/assets/js/33.a22f85f8.js"><link rel="prefetch" href="/assets/js/34.5ac595eb.js"><link rel="prefetch" href="/assets/js/35.01736eef.js"><link rel="prefetch" href="/assets/js/36.63d4161d.js"><link rel="prefetch" href="/assets/js/37.ac568153.js"><link rel="prefetch" href="/assets/js/38.6ab48214.js"><link rel="prefetch" href="/assets/js/39.73e8152b.js"><link rel="prefetch" href="/assets/js/4.272a9fbd.js"><link rel="prefetch" href="/assets/js/40.2c194813.js"><link rel="prefetch" href="/assets/js/41.fe37b6f6.js"><link rel="prefetch" href="/assets/js/42.6f73345b.js"><link rel="prefetch" href="/assets/js/43.adc53b2c.js"><link rel="prefetch" href="/assets/js/44.310ae361.js"><link rel="prefetch" href="/assets/js/45.32e660b6.js"><link rel="prefetch" href="/assets/js/46.04890be7.js"><link rel="prefetch" href="/assets/js/47.4a68ffe5.js"><link rel="prefetch" href="/assets/js/48.90a9137b.js"><link rel="prefetch" href="/assets/js/49.58b6c3b6.js"><link rel="prefetch" href="/assets/js/5.f83283dc.js"><link rel="prefetch" href="/assets/js/50.043bd85d.js"><link rel="prefetch" href="/assets/js/51.c53db7d0.js"><link rel="prefetch" href="/assets/js/52.b419676d.js"><link rel="prefetch" href="/assets/js/53.36f713df.js"><link rel="prefetch" href="/assets/js/54.8002161b.js"><link rel="prefetch" href="/assets/js/55.cc1fc344.js"><link rel="prefetch" href="/assets/js/56.05a6ea6d.js"><link rel="prefetch" href="/assets/js/57.90a9d9ee.js"><link rel="prefetch" href="/assets/js/58.7b07447f.js"><link rel="prefetch" href="/assets/js/59.c17fc2f2.js"><link rel="prefetch" href="/assets/js/6.8a86adbf.js"><link rel="prefetch" href="/assets/js/60.66b80346.js"><link rel="prefetch" href="/assets/js/61.3a7ccc82.js"><link rel="prefetch" href="/assets/js/62.fb35378d.js"><link rel="prefetch" href="/assets/js/63.27e61864.js"><link rel="prefetch" href="/assets/js/64.64d01d10.js"><link rel="prefetch" href="/assets/js/65.a80a9fc0.js"><link rel="prefetch" href="/assets/js/66.5dc463c7.js"><link rel="prefetch" href="/assets/js/67.4a805afa.js"><link rel="prefetch" href="/assets/js/68.8287eee7.js"><link rel="prefetch" href="/assets/js/69.892294f6.js"><link rel="prefetch" href="/assets/js/7.5465fa65.js"><link rel="prefetch" href="/assets/js/70.e0ec7ddd.js"><link rel="prefetch" href="/assets/js/71.7256a53d.js"><link rel="prefetch" href="/assets/js/72.f96155a0.js"><link rel="prefetch" href="/assets/js/73.5a0eb88e.js"><link rel="prefetch" href="/assets/js/74.23636aea.js"><link rel="prefetch" href="/assets/js/75.50267214.js"><link rel="prefetch" href="/assets/js/76.56bf8931.js"><link rel="prefetch" href="/assets/js/77.50bf124e.js"><link rel="prefetch" href="/assets/js/78.16447a1c.js"><link rel="prefetch" href="/assets/js/79.04aa7ebf.js"><link rel="prefetch" href="/assets/js/8.87101dd9.js"><link rel="prefetch" href="/assets/js/80.5d01a188.js"><link rel="prefetch" href="/assets/js/81.f8607d18.js"><link rel="prefetch" href="/assets/js/82.34e8cb67.js"><link rel="prefetch" href="/assets/js/83.947a3b57.js"><link rel="prefetch" href="/assets/js/84.1c193059.js"><link rel="prefetch" href="/assets/js/85.8b1b503f.js"><link rel="prefetch" href="/assets/js/86.c530b306.js"><link rel="prefetch" href="/assets/js/87.06e6da51.js"><link rel="prefetch" href="/assets/js/88.10805f35.js"><link rel="prefetch" href="/assets/js/89.60cd520b.js"><link rel="prefetch" href="/assets/js/9.4e64f5b9.js"><link rel="prefetch" href="/assets/js/90.5d7e2d93.js"><link rel="prefetch" href="/assets/js/91.ddff81c9.js"><link rel="prefetch" href="/assets/js/92.d7928325.js"><link rel="prefetch" href="/assets/js/93.33fd0965.js"><link rel="prefetch" href="/assets/js/94.560df3d9.js"><link rel="prefetch" href="/assets/js/95.283a51cc.js"><link rel="prefetch" href="/assets/js/96.a8d91103.js"><link rel="prefetch" href="/assets/js/97.fe4a7179.js"><link rel="prefetch" href="/assets/js/98.064d454e.js"><link rel="prefetch" href="/assets/js/99.f6443506.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a748b10c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Zhoujc's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end/" class="nav-link router-link-active">
  前端相关
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node实践
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end/" class="nav-link router-link-active">
  前端相关
</a></div><div class="nav-item"><a href="/node/" class="nav-link">
  Node实践
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><a href="/ai/" class="nav-link">
  AI
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/front-end/" aria-current="page" class="sidebar-link">前端系列</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end/js/event-loop/" aria-current="page" class="active sidebar-link">js执行机制详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#javascript" class="sidebar-link">javascript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#事件循环" class="sidebar-link">事件循环</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#node-event-loop" class="sidebar-link">Node Event Loop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#timer" class="sidebar-link">timer</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#i-o" class="sidebar-link">I/O</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#idle-prepare" class="sidebar-link">idle，prepare</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#poll" class="sidebar-link">poll</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#check" class="sidebar-link">check</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#close-callbacks" class="sidebar-link">close callbacks</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#最后" class="sidebar-link">最后</a></li><li class="sidebar-sub-header"><a href="/front-end/js/event-loop/#思考" class="sidebar-link">思考</a></li></ul></li><li><a href="/front-end/js/promise/" class="sidebar-link">深入理解promise</a></li><li><a href="/front-end/js/prototype/" class="sidebar-link">深入理解js原型</a></li><li><a href="/front-end/js/flatten/" class="sidebar-link">数组扁平化</a></li><li><a href="/front-end/js/throttle/" class="sidebar-link">节流与防抖</a></li><li><a href="/front-end/js/curry/" class="sidebar-link">函数柯里化</a></li><li><a href="/front-end/js/continuous-assignment/" class="sidebar-link">连续赋值的理解</a></li><li><a href="/front-end/js/design/factory.html" class="sidebar-link">设计模式-工厂函数</a></li><li><a href="/front-end/js/design/constructor.html" class="sidebar-link">设计模式-构造函数</a></li><li><a href="/front-end/js/bind/" class="sidebar-link">模拟实现call, apply, bind</a></li><li><a href="/front-end/js/closure/" class="sidebar-link">一道经典的闭包面试题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器和网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>绘图</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js执行机制详解"><a href="#js执行机制详解" class="header-anchor">#</a> js执行机制详解</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>理解 javascript 的执行机制有助于我们更好的编写代码逻辑以及排查问题。</p> <p>抛砖引玉，先上个🌰：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/assets/img/think.6666e1f6.jpg" alt=""></p> <p>下面我们分析一下相关知识点：</p> <h2 id="javascript"><a href="#javascript" class="header-anchor">#</a> javascript</h2> <p>javascript 是一门 <strong style="font-size:20px;">单线程</strong> 语言，作为浏览器脚本语言，它的主要用途就是与用户交互，以及操作 DOM ，这个性质也决定了它是单线程，不然多线程的话，就会有很多复杂性的同步问题。为利用多核 CPU 的计算能力，最新的 HTML5 中提出的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener noreferrer">Web-Worker<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 标准，允许 javascript 创建多个线程，但子线程完全受主线程控制，且不得操作 DOM。所以 javascript 是单线程的核心从未改变，一切 javascript 版的 “多线程” 都是单线程模拟出来的。</p> <h3 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h3> <p>既然是单线程就意味着，所有任务都需要排队，前一个任务结束，才能执行后一个任务。如果前一个任务耗时很长，那么后一个任务就不得不一直等待。因此大佬们就把任务分成了两类：</p> <ol><li>同步: 只有前一个任务执行完毕，才能执行后一个任务。</li> <li>异步: 当同步任务执行到某个 WebAPI 时，会触发异步操作，此时浏览器会单独开线程去处理这些异步任务。</li></ol> <p>下面用最火的导图来补充说明下：</p> <p><img src="/assets/img/event-loop.a389be99.png" alt=""></p> <p>用文字来表述的话：</p> <ol><li>同步任务进入主线程，异步任务进入 Event Table 注册站进行注册函数。</li> <li>当指定的事情完成时，Event Table 会将这个事情对应的函数移入 Event Queue 这个缓冲区。</li> <li>主线程内的任务执行完为空时，就会去 Event Queue 读取对应的函数，进入主线程执行。</li> <li>js引擎的 monitoring process 进程会持续不断的检查主线程执行栈是否为空，一旦为空，就会去缓冲区检查是否有等待被调用的函数，上述过程会不断重复，也就是常说的 Event Loop (事件循环)。</li></ol> <p>说了这么多，不如来看一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
</code></pre></div><p>上面一段简易的 setTimeout 代码：</p> <ol><li>输出1</li> <li>遇到 setTimeout 进入 Event Table，注册回调函数 <code>() =&gt; { console.log('2') }</code></li> <li>输出3</li> <li>主线程从 Event Queue 读取回调函数并执行输出2</li></ol> <h4 id="micro-task-与-macro-task"><a href="#micro-task-与-macro-task" class="header-anchor">#</a> micro task 与 macro task</h4> <p>异步任务的优先级并不相同，它们被分为两类：</p> <ol><li>微任务（micro task）: Promise，process.nextTick，MutationObserver...</li> <li>宏任务（macro task）：包括整体代码script，setTimeout，serInterval，setImmediate，I/O，UIrendering...</li></ol> <p>根据异步事件的类型，这些事件会被派发到对应的微任务和宏任务中，在当前主线程执行完毕后：</p> <ol><li>首先在 宏任务 的队列中取出第一个任务，执行完毕后取出 微任务 队列中的所有任务顺序执行。</li> <li>再取 宏任务 周而复始，直至两个队列的任务都取完。</li></ol> <p>我们用图来说明一下：</p> <p><img src="/assets/img/task.c3b4bab3.png" alt=""></p> <p>来看一段代码理解下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span>
</code></pre></div><p>第一轮事件循环</p> <ul><li>宏任务
<ul><li>整体script</li></ul></li> <li>微任务
<ul><li>then</li></ul></li></ul> <ol><li>首先整体script作为宏任务，进入主线程。</li> <li>先遇到 setTimeout 注册后派发到宏任务。</li> <li>再遇到 Promise，new Promise 立即执行，then 函数派发到微任务。</li> <li><code>console.log('console')</code>，立即执行。</li></ol> <p>开始第二轮</p> <ul><li>宏任务
<ul><li>setTimeout</li></ul></li> <li>微任务
<ul><li>无</li></ul></li></ul> <ol><li>第一轮事件循环结束了，我们开始第二轮循环，当然要从宏任务Event Queue 开始发现 setTimeout 立即执行。</li></ol> <p>结果输出：</p> <div class="language-js extra-class"><pre class="language-js"><code>promise
console
then
setTimeout
</code></pre></div><p>最后回过头来，让我们再分析下最开始的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">// setTimeout1</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// then4</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// then6</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// setTimeout2</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// then9</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>为了方便下面记录分析，先在代码上做个标记。再根据上面的事件循环导图就可以得出以下结论：</p> <p>第一轮事件循环</p> <ol><li>宏任务： 整体script</li> <li>微任务：then6</li> <li>输出1，5，6</li></ol> <p>第二轮事件循环</p> <ol><li>宏任务： setTimeout1</li> <li>微任务：then4</li> <li>输出2，3，4</li></ol> <p>第三轮事件循环</p> <ol><li>宏任务： setTimeout2</li> <li>微任务：then9</li> <li>输出7，8，9</li></ol> <p>所以在浏览器端输出的结果为1，5，6，2，3，4，7，8，9。</p> <p>接下去我们看下在 Node 环境下里它会是怎么样？</p> <h2 id="node-event-loop"><a href="#node-event-loop" class="header-anchor">#</a> Node Event Loop</h2> <p>当 nodejs 启动后，它会初始化事件轮训，它可能会调用一些异步API，调度定时器，或者 <code>process.nextTick()</code> 等，然后开始处理事件循环。</p> <p>它会分为6个阶段，按照顺序循环进行：</p> <p><img src="data:image/jpeg;base64,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" alt=""></p> <h3 id="timer"><a href="#timer" class="header-anchor">#</a> timer</h3> <p>本阶段执行 <code>setTimeout</code> 和 <code>setInterval</code> 的回调。</p> <p>计时器指定可以执行所提供回调的阈值，而不是用户希望其执行的确切时间。在指定的一段时间间隔后， 计时器回调将被尽可能早地运行。但是，操作系统调度或其它正在运行的回调可能会延迟它们。它们由 poll 阶段控制何时执行</p> <h3 id="i-o"><a href="#i-o" class="header-anchor">#</a> I/O</h3> <p>上一轮未执行的，被延迟到下一个循环迭代的I/O回调</p> <h3 id="idle-prepare"><a href="#idle-prepare" class="header-anchor">#</a> idle，prepare</h3> <p>系统内部使用</p> <h3 id="poll"><a href="#poll" class="header-anchor">#</a> poll</h3> <p>轮询阶段会有两个重要功能：</p> <ol><li>计算阻塞和 poll I/O的时间</li> <li>执行 poll 队列里的事件</li></ol> <p>并且在进入该阶段时如果没有设定了 timer 的话，会发生以下两件事情</p> <ol><li>如果 poll 队列不为空，会遍历回调队列并同步执行，直到队列为空或者达到系统限制</li> <li>如果 poll 队列为空时，会有两件事发生：</li></ol> <ul><li>如果有 <code>setImmediate</code> 回调需要执行，poll 阶段会停止并且进入到 check 阶段执行回调</li> <li>如果没有 <code>setImmediate</code> 回调需要执行，会等待回调被加入到队列中并立即执行回调，这里同样会有个超时时间设置防止一直等待下去</li></ul> <p>当然设定了 timer 的话且 poll 队列为空，则会判断是否有 timer 超时，如果有的话会回到 timer 阶段执行回调。</p> <h3 id="check"><a href="#check" class="header-anchor">#</a> check</h3> <p>check 阶段执行 <code>setImmediate</code></p> <h3 id="close-callbacks"><a href="#close-callbacks" class="header-anchor">#</a> close callbacks</h3> <p>如果套接字或句柄突然关闭（例如<code>socket.destroy()</code>），则在此阶段将发出'close'事件。否则它将通过<code>process.nextTick()</code>发出。</p> <p>了解了这些阶段后，我们通过一些代码再来理解一下。</p> <p>首先在某种特定的情况下，定时器timer的执行顺序是随机的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>结果是 setTimeout 可能执行在前也可能在后。
事件循环的延迟可能足够低，以至于计时器在立即触发后触发，本身事件循环也是需要成本的，如果在准备时候花费了大于 1ms 的时间，那么在 timer 阶段就会直接执行 setTimeout 回调，如果准备时间花费小于 1ms，那么就是 setImmediate 回调先执行了。</p> <p>在下面这个场景下，执行顺序一定是固定的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在上述代码中，setImmediate 永远先执行。因为两个代码写在 IO 回调中，IO 回调是在 poll 阶段执行，当回调执行完毕后队列为空，发现存在 setImmediate 回调，所以就直接跳转到 check 阶段去执行回调了。</p> <p>最后我们来看看 Node 中的 <code>process.nextTick</code>，这个函数其实是独立于 Event Loop 之外的，它有一个自己的队列，当每个阶段完成后，如果存在 nextTick 队列，就会清空队列中的所有回调函数，并且优先于其他 microtask 执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span>

 Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
 process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
   process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>对于以上代码，无论如何，永远都是先把 nextTick 全部打印出来。
了解了 node 的事件循环以后，再回过头来看看最初始的例子，你就会发现它输出的结果是：1, 5, 6, 2, 3, 7, 8, 4, 9。</p> <p>总结一下 node 的执行机制大概如下：
<img src="/assets/img/node-event-loop.17c30a4e.jpg" alt=""></p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <ol><li>javascript 是一门单线程语言</li> <li>Event Loop是 javascript 的执行机制</li> <li>EVent Loop在浏览器和 Node 环境下却又是完全不一样的机制</li></ol> <h2 id="思考"><a href="#思考" class="header-anchor">#</a> 思考</h2> <p>留下一道扩展题，结合async，await，在浏览器和node环境下又输出什么？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token function"> async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async1 start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
  <span class="token keyword">await</span><span class="token function"> async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async1 end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  
<span class="token keyword">async</span> <span class="token keyword">function</span><span class="token function"> async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async-settimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token function"> </span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async2-promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token function"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;async2-then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;script start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token function"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;settimeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token function"> </span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token function"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;promise2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-end/" class="prev router-link-active">
        前端系列
      </a></span> <span class="next"><a href="/front-end/js/promise/">
        深入理解promise
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ebc66fdf.js" defer></script><script src="/assets/js/2.d4b9d712.js" defer></script><script src="/assets/js/12.0e09de73.js" defer></script>
  </body>
</html>
